variables:
  DIND_IMAGE: docker:24.0.6-dind-alpine3.18
  MLFLOW_REPO_PATH: mlflow
  GCP_LOCATION: asia-southeast1-docker.pkg.dev
  GCP_REPO: machine-learning-ops/mlflow-server/v2/mlflow
  HARBOR_URI: registry.aisingapore.net
  HARBOR_REPO: mlops-pub/mlflow-server


stages:
  - verify
  - build

verify-image-gcp:
  stage: verify
  tags:
    - dind
  image: "${DIND_IMAGE}"
  rules:
    - if: $PLATFORM == "gcp"
  script:
    - exit_code=$(docker pull "${GCP_LOCATION}/${GCP_REPO}/mlflow:${IMAGE_TAG}" &> /dev/null && echo $?)
    - >-
      if [[ $exit_code == 0 ]];
        then echo "Image - ${GCP_LOCATION}/${GCP_REPO}:${IMAGE_TAG} found; skipping job.";
        exit 1;
      fi

verify-image-harbor:
  stage: verify
  tags:
    - dind
    - on-prem
  image: "${DIND_IMAGE}"
  rules:
    - if: $PLATFORM == "onprem"
  before_script:
    - echo "${HARBOR_PASSWORD}" | docker login "https://${HARBOR_URI}" -u "${HARBOR_USERNAME}" --password-stdin
  script:
    - docker pull "${HARBOR_URI}/${HARBOR_REPO}:${IMAGE_TAG}"
    - exit_code=$(docker pull "${HARBOR_URI}/${HARBOR_REPO}:${IMAGE_TAG}" &> /dev/null && echo $?)
    - |+
      if [[ $exit_code == 0 ]]
        then echo "Image - ${HARBOR_URI}/${HARBOR_REPO}:${IMAGE_TAG} found; skipping job."
        exit 1
      fi

generate-access-token-gcp:
  stage: build
  image: google/cloud-sdk:slim
  tags:
    - gcp
  rules:
    - if: $PLATFORM == "gcp"
  needs:
    - job: verify-image-gcp
  before_script:
    - cat $GCP_SA_KEY >> gcp_sa.json
  script:
    - gcloud auth login --cred-file gcp_sa.json
    - gcp_token=$(gcloud auth print-access-token)
    - echo "GCP_TOKEN=${gcp_token}" >> gcp_token.env
  artifacts:
    reports:
      dotenv: gcp_token.env
    expire_in: 1hr

build-gcp:
  stage: build
  image: "${DIND_IMAGE}"
  tags:
    - gcp
    - dind
  rules:
    - if: $PLATFORM == "gcp"
  needs:
    - job: generate-access-token-gcp
      artifacts: true
  before_script:
    - echo ${GCP_TOKEN} | docker login -u oauth2accesstoken --password-stdin
      "https://${GCP_LOCATION}"
  script:
    - cd "${CI_PROJECT_DIR}/mlflow"
    - docker build 
      -t "${GCP_LOCATION}/${GCP_REPO}:${IMAGE_TAG}" 
      -f mlflow-server.Dockerfile
      --build-arg "MLFLOW_VER=${IMAGE_TAG}" .
    - docker push "${GCP_LOCATION}/${GCP_REPO}:${IMAGE_TAG}"

build-harbor:
  stage: build
  image: gcr.io/kaniko-project/executor:v1.15.0-debug
  tags:
    - dind
    - on-prem
  rules:
    - if: $PLATFORM == "onprem"
  needs:
    - job: verify-image-harbor
  before_script:
    - harbor_creds=$(echo -n "${HARBOR_USERNAME}:${HARBOR_PASSWORD}" | base64)
    - echo "{\"auths\":{\"https://${HARBOR_URI}\":{\"auth\":\"$harbor_creds\"}}}" >> /.docker/config.json
  script:
    - executor
      --context "${CI_PROJECT_DIR}/mlflow"
      -d "${HARBOR_URI}/${HARBOR_REPO}:${IMAGE_TAG}"
      -f mlflow-server.Dockerfile
      --build-arg "MLFLOW_VER=${IMAGE_TAG}" 

